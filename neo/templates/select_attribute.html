<html class="x-admin-sm">

<head>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
    <meta charset="UTF-8">
    <title>知识图谱总览</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../static/lib/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../static/lib/layui/css/layui.mobile.css">
    <link rel="stylesheet" href="../static/css/font.css">
    <link rel="stylesheet" href="../static/css/xadmin.css">
    <script src="../static/lib/layui/layui.js"></script>
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/xadmin.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.3.1/echarts.min.js"></script>
</head>

<body>
    <div class="layui-fluid">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <blockquote class="layui-elem-quote">
                            查询得到的结果有可能返回值为空，即无法显示对应的节点，可能是没有相应的药材，可以不限制产地进行查询。
                            <p style="white-space:pre">一些tips: 1、鼠标悬浮在节点上方可以显示节点详情 2、鼠标点击节点可以打开节点详情页面</p>
                        </blockquote>
                        {% comment %} <label class="layui-form-label">依照性味、产地筛分中药种类</label> {% endcomment %}
                        <form class="layui-form" action="" method="POST">
                            <div class="layui-form-item">
                                <label class="layui-form-label">药性</label>
                                <div class="layui-input-block">
                                    <select name="hrep_type" lay-filter="aihao">
                                        <option value="0">任意</option>
                                        <option value="1">热性</option>
                                        <option value="2">温性</option>
                                        <option value="3">寒性</option>
                                        <option value="4">凉性</option>
                                        <option value="5">平性</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">药味</label>
                                <div class="layui-input-block">
                                    <select name="hrep_feel" lay-filter="aihao">
                                        <option value="0">任意</option>
                                        <option value="1">甘</option>
                                        <option value="2">苦</option>
                                        <option value="3">辛</option>
                                        <option value="4">酸</option>
                                        <option value="5">咸</option>
                                        <option value="6">涩</option>
                                        <option value="7">淡</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">产地</label>
                                <div class="layui-input-block">
                                    <select name="hrep_place" lay-filter="aihao">
                                        <option value="0">任意</option>
                                        <option value="1">安徽</option>
                                        <option value="2">澳门</option>
                                        <option value="3">北京</option>
                                        <option value="4">重庆</option>
                                        <option value="5">福建</option>
                                        <option value="6">甘肃</option>
                                        <option value="7">广东</option>
                                        <option value="8">广西</option>
                                        <option value="9">贵州</option>
                                        <option value="10">海南</option>
                                        <option value="11">河北</option>
                                        <option value="12">河南</option>
                                        <option value="13">黑龙江</option>
                                        <option value="14">湖北</option>
                                        <option value="15">湖南</option>
                                        <option value="16">吉林</option>
                                        <option value="17">江苏</option>
                                        <option value="18">江西</option>
                                        <option value="19">辽宁</option>
                                        <option value="20">内蒙古</option>
                                        <option value="21">宁夏</option>
                                        <option value="22">青海</option>
                                        <option value="23">山东</option>
                                        <option value="24">山西</option>
                                        <option value="25">陕西</option>
                                        <option value="26">上海</option>
                                        <option value="27">四川</option>
                                        <option value="28">台湾</option>
                                        <option value="29">天津</option>
                                        <option value="30">西藏</option>
                                        <option value="31">香港</option>
                                        <option value="32">新疆</option>
                                        <option value="33">云南</option>
                                        <option value="34">浙江</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn" lay-submit lay-filter="*">立即提交</button>
                                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                </div>
                            </div>
                            <!-- 更多表单结构排版请移步文档左侧【页面元素-表单】一项阅览 -->
                        </form>
                        <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
                        <div id="main" style="width: 100%;height:600px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        layui.use(['form'], function () {
            var form = layui.form;
            // 监听单选框的选择变化
            $('input[name="kind"]').on('change', function () {
                var value = $(this).val();
                $('.div-container > div').hide();
                $('.div' + value).show();
            });
            form.render();//动态插入的更新渲染
        });
    </script>
    <script src="https://cdn.bootcss.com/echarts/4.2.1-rc1/echarts.min.js"></script>
    <script src="https://cdn.bootcss.com/echarts/4.2.1-rc1/extension/bmap.min.js"></script>
    <script type="text/javascript">
        function hideLoadingSpinner() {
            document.getElementById('loading-spinner').style.display = 'none';
        }
        var myChart = echarts.init(document.getElementById('main'));
        var categories = [];
        link = [];

        var jsonData = {{ result|safe }}; // 传入查询结果的json字典形式
        
        var node = [];
        for (var i = 0; i < jsonData.length; i++) {
            var item = jsonData[i];
            item.des = jsonData[i].name;
            item.symbolSize = 60;
            item.category = 0;
            node.push(item);
        }
        console.log(node);
        for (var i = 0; i < 1; i++) { // 筛选，只有一个类别
            categories[i] = {
                name: '药材'
            };
        }
        option = {
            // 图的标题
            title: {
                text: '查询结果'
            },
            // 提示框的配置
            tooltip: {
                trigger: 'item',
                backgroundColor: 'transparent',
                formatter: function (params) {
                    var node = params.data;
                    var str = '<div style="width:600px;padding:10px;box-sizing:border-box;border-radius:4px;position:relative;background:rgba(0,0,0,0.8);">';
                    str += '<div style="display:flex;align-items:center;"><strong>' + node.des + '</strong></div>';
                    var En2Ch = {
                        'feature': "性味归经",
                        "form": "形态",
                        "attending": "临床应用",
                        "function": "功效与作用",
                        "warning": "使用禁忌",
                        "alias": "别名",
                        "place": "产地分布",
                        "picture": "图片",
                        "english_name": "英文名",
                        "type": "类型",
                        "composition": "组成",
                        "usage": "用法",
                        "source": "起点",
                        "target": "终点",
                        "name": "名称"
                    };
                    // 添加图片内容
                    if (node.picture) {
                        var imageStyle = 'max-width:100%;height:auto;';
                        var loadingStyle = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);';
                        var loadingHtml = '<div id="loading-spinner" style="' + loadingStyle + '">' +
                            '<div style="border: 3px solid #f3f3f3;border-top: 3px solid #3498db;border-radius: 50%;width: 16px;height: 16px;animation: spin 2s linear infinite;"></div>' +
                            '</div>';
                        var imgHtml = '<img src="' + node.picture + '" style="' + imageStyle + '" onload="hideLoadingSpinner()">';

                        str += '<div style="position:relative;">' + imgHtml + loadingHtml + '</div>';
                    }

                    // 添加节点属性
                    for (var key in node) {
                        if (key !== 'des' && key !== 'symbolSize' && key !== 'category' && key !== 'picture' && key !== 'label' && key !== 'name' && key !== 'emphasis') {
                            str += '<div style="word-wrap: break-word; width: 100%;white-space:normal; text-align: left;"><span">' + En2Ch[key] + ':</span>' + node[key] + '</div>';
                        }
                    }

                    str += '</div>';
                    return str;
                },
            },
            // 工具箱
            toolbox: {
                // 显示工具箱
                show: true,
                feature: {
                    mark: {
                        show: true
                    },
                    // 还原
                    restore: {
                        show: true
                    },
                    // 保存为图片
                    saveAsImage: {
                        show: true
                    }
                }
            },
            legend: [{
                // selectedMode: 'single',
                data: categories.map(function (a) {
                    return a.name;
                })
            }],
            series: [{
                type: 'graph', // 类型:关系图
                layout: 'force', //图的布局，类型为力导图
                symbolSize: 40, // 调整节点的大小
                roam: true, // 是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移,可以设置成 'scale' 或者 'move'。设置成 true 为都开启
                edgeSymbol: ['circle', 'arrow'],
                edgeSymbolSize: [2, 10],
                edgeLabel: {
                    normal: {
                        textStyle: {
                            fontSize: 12
                        },
                        show: true,
                        formatter: function (x) {
                            return x.data.name;
                        }
                    }
                },
                force: {
                    repulsion: 2500,
                    edgeLength: [10, 50]
                },
                draggable: true,
                lineStyle: {
                    normal: {
                        width: 2,
                        color: '#4b565b',
                    }
                },
                label: {
                    normal: {
                        show: true,
                        textStyle: {}
                    }
                },

                // 数据
                data: node,
                links: link,
                categories: categories,
            }]
        };

        myChart.setOption(option);
        myChart.on('click', function (params) {
            if (params.dataType == 'node') {
                var confirmResult = confirm("是否要打开该节点的详情页面？");
                if (confirmResult) {
                    var url = "http://www.a-hospital.com/w/" + params.name;
                    var title = params.name + "-详情页";
                    parent.xadmin.add_tab(title, url);
                }
            }
        });
    </script>
</body>

</html>